-- Script Completo JetBus Pro (Versión Final)
-- Fecha: 15-02-2026

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- 1. Crear Base de Datos
CREATE DATABASE IF NOT EXISTS `venta_pasajes_db` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE `venta_pasajes_db`;

-- 2. Eliminar tablas antiguas si existen (Reinicio limpio)
DROP TABLE IF EXISTS `pasajes`;
DROP TABLE IF EXISTS `ventas`;
DROP TABLE IF EXISTS `pasajeros`;
DROP TABLE IF EXISTS `viajes`;
DROP TABLE IF EXISTS `precios_tramos`;
DROP TABLE IF EXISTS `ruta_paradas`;
DROP TABLE IF EXISTS `rutas`;
DROP TABLE IF EXISTS `tarifas`;
DROP TABLE IF EXISTS `buses`;
DROP TABLE IF EXISTS `paradas`;
DROP TABLE IF EXISTS `oficinas`;

-- --------------------------------------------------------

-- 3. Estructura de Tablas

-- Tabla: Oficinas (Para Cierre de Caja)
CREATE TABLE `oficinas` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `nombre` VARCHAR(100) NOT NULL
) ENGINE=InnoDB;

-- Tabla: Paradas (Ciudades/Pueblos)
CREATE TABLE `paradas` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `nombre` VARCHAR(100) NOT NULL UNIQUE
) ENGINE=InnoDB;

-- Tabla: Flota de Buses
CREATE TABLE `buses` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `numero_bus` VARCHAR(20) NOT NULL UNIQUE,
  `patente` VARCHAR(10) NOT NULL UNIQUE,
  `modelo` VARCHAR(100),
  `asientos` INT NOT NULL,
  `estado` ENUM('Activo', 'En Panne') DEFAULT 'Activo'
) ENGINE=InnoDB;

-- Tabla: Tarifas (Descuentos)
CREATE TABLE `tarifas` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `nombre` VARCHAR(50) NOT NULL UNIQUE,
  `descuento` INT NOT NULL DEFAULT 0
) ENGINE=InnoDB;

-- Tabla: Definición de Rutas
CREATE TABLE `rutas` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `nombre` VARCHAR(100) NOT NULL
) ENGINE=InnoDB;

-- Tabla: Orden de Paradas por Ruta
CREATE TABLE `ruta_paradas` (
  `ruta_id` INT NOT NULL,
  `parada_id` INT NOT NULL,
  `orden` INT NOT NULL,
  PRIMARY KEY (`ruta_id`, `parada_id`),
  FOREIGN KEY (`ruta_id`) REFERENCES `rutas`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`parada_id`) REFERENCES `paradas`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB;

-- Tabla: Precios por Tramo
CREATE TABLE `precios_tramos` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `origen_id` INT NOT NULL,
  `destino_id` INT NOT NULL,
  `precio` DECIMAL(10, 2) NOT NULL,
  UNIQUE (`origen_id`, `destino_id`),
  FOREIGN KEY (`origen_id`) REFERENCES `paradas`(`id`),
  FOREIGN KEY (`destino_id`) REFERENCES `paradas`(`id`)
) ENGINE=InnoDB;

-- Tabla: Viajes Programados
CREATE TABLE `viajes` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `ruta_id` INT NOT NULL,
  `bus_id` INT NOT NULL,
  `chofer_nombre` VARCHAR(150) NOT NULL,
  `fecha_hora_salida` DATETIME NOT NULL,
  `estado` ENUM('Programado', 'Cancelado') DEFAULT 'Programado',
  FOREIGN KEY (`ruta_id`) REFERENCES `rutas`(`id`),
  FOREIGN KEY (`bus_id`) REFERENCES `buses`(`id`)
) ENGINE=InnoDB;

-- Tabla: Base de Datos de Pasajeros (Historial)
CREATE TABLE `pasajeros` (
  `rut` VARCHAR(12) PRIMARY KEY,
  `nombre_completo` VARCHAR(150) NOT NULL,
  `telefono` VARCHAR(20) NULL
) ENGINE=InnoDB;

-- Tabla: Ventas (Cabecera de la transacción)
CREATE TABLE `ventas` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `codigo_venta` VARCHAR(20) NOT NULL UNIQUE, -- Folio diario
  `viaje_id` INT NOT NULL,
  `oficina_id` INT NULL, -- Oficina donde se hizo la venta
  `comprador_rut` VARCHAR(12) NOT NULL,
  `total_pagado` DECIMAL(10, 2) NOT NULL,
  `metodo_pago` VARCHAR(50) NOT NULL,
  `fecha_venta` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `estado` ENUM('Confirmado', 'Anulado') DEFAULT 'Confirmado',
  FOREIGN KEY (`viaje_id`) REFERENCES `viajes`(`id`),
  FOREIGN KEY (`oficina_id`) REFERENCES `oficinas`(`id`)
) ENGINE=InnoDB;

-- Tabla: Pasajes (Detalle de cada asiento vendido)
CREATE TABLE `pasajes` (
  `id` INT AUTO_INCREMENT PRIMARY KEY,
  `venta_id` INT NOT NULL,
  `viaje_id` INT NOT NULL,
  `numero_asiento` INT NOT NULL,
  `pasajero_rut` VARCHAR(12) NOT NULL,
  `pasajero_nombre` VARCHAR(150) NOT NULL,
  `origen_id` INT NOT NULL,
  `destino_id` INT NOT NULL,
  `tarifa_id` INT NOT NULL,
  `precio_final` DECIMAL(10, 2) NOT NULL,
  `anotacion_subida` TEXT NULL,
  FOREIGN KEY (`venta_id`) REFERENCES `ventas`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`viaje_id`) REFERENCES `viajes`(`id`),
  FOREIGN KEY (`origen_id`) REFERENCES `paradas`(`id`),
  FOREIGN KEY (`destino_id`) REFERENCES `paradas`(`id`),
  FOREIGN KEY (`tarifa_id`) REFERENCES `tarifas`(`id`)
) ENGINE=InnoDB;

-- --------------------------------------------------------

-- 4. Carga de Datos Iniciales

-- Oficinas
INSERT INTO `oficinas` (nombre) VALUES 
('Concepción'), 
('Laraquete'), 
('Curanilahue'), 
('Cerro Alto'), 
('Cañete');

-- Paradas
INSERT INTO `paradas` (id, nombre) VALUES 
(1,'Concepción'),
(2,'Laraquete'),
(3,'Curanilahue'),
(4,'Cañete'),
(5,'Cerro Alto'); 

-- Tarifas (Estudiante al 33%)
INSERT INTO `tarifas` (nombre, descuento) VALUES 
('Adulto', 0),
('Estudiante', 33),
('Adulto Mayor', 50);

-- Buses
INSERT INTO `buses` (numero_bus, patente, modelo, asientos) VALUES 
('101', 'ABCD-11', 'Marcopolo G7', 46),
('102', 'EFGH-22', 'Marcopolo G8', 46);

-- Rutas
INSERT INTO `rutas` (id, nombre) VALUES 
(1, 'CONCEPCIÓN - CAÑETE (IDA)'),
(2, 'CAÑETE - CONCEPCIÓN (VUELTA)');

-- Secuencia de Ruta 1 (Ida)
INSERT INTO `ruta_paradas` (ruta_id, parada_id, orden) VALUES 
(1,1,1), -- Concepción
(1,2,2), -- Laraquete
(1,3,3), -- Curanilahue
(1,5,4), -- Cerro Alto
(1,4,5); -- Cañete

-- Secuencia de Ruta 2 (Vuelta)
INSERT INTO `ruta_paradas` (ruta_id, parada_id, orden) VALUES 
(2,4,1), -- Cañete
(2,5,2), -- Cerro Alto
(2,3,3), -- Curanilahue
(2,2,4), -- Laraquete
(2,1,5); -- Concepción

-- Precios por Tramo
INSERT INTO `precios_tramos` (origen_id, destino_id, precio) VALUES 
-- Desde Concepción
(1,4, 7000.00), -- a Cañete
(1,3, 4500.00), -- a Curanilahue
(1,5, 6000.00), -- a Cerro Alto
(1,2, 2000.00), -- a Laraquete

-- Desde Curanilahue
(3,4, 3000.00), -- a Cañete
(3,5, 1500.00), -- a Cerro Alto

-- Desde Cerro Alto
(5,4, 1500.00), -- a Cañete

-- Vueltas (Inversas)
(4,1, 7000.00), 
(3,1, 4500.00),
(5,1, 6000.00), 
(2,1, 2000.00),
(4,3, 3000.00),
(5,3, 1500.00),
(4,5, 1500.00);

-- Viajes de Prueba (Para el día actual)
INSERT INTO `viajes` (ruta_id, bus_id, chofer_nombre, fecha_hora_salida) VALUES 
(1, 1, 'Juan Pérez', CONCAT(CURDATE(), ' 09:30:00')), 
(2, 2, 'Pedro Soto', CONCAT(CURDATE(), ' 14:00:00'));

SET FOREIGN_KEY_CHECKS = 1;