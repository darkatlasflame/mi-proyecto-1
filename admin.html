<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JetBus Admin | Panel de Control</title>
    <style>
        :root { --p: #1e293b; --s: #3b82f6; --bg: #f1f5f9; --card: #ffffff; --text: #334155; }
        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 0; }
        body { display: grid; grid-template-columns: 250px 1fr; height: 100vh; background: var(--bg); color: var(--text); }
        
        /* Sidebar */
        aside { background: var(--p); color: white; padding: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .brand { font-size: 1.5rem; font-weight: 800; margin-bottom: 2rem; color: white; display: flex; align-items: center; gap: 10px; }
        .brand span { color: #facc15; }
        .nav-btn { padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; background: transparent; border: none; color: #94a3b8; text-align: left; font-weight: 600; font-size: 0.95rem; }
        .nav-btn:hover, .nav-btn.active { background: #334155; color: white; }
        .nav-btn.active { border-left: 4px solid var(--s); }

        /* Main Content */
        main { padding: 2rem; overflow-y: auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        h1 { font-size: 1.8rem; color: var(--p); }
        
        .card { background: var(--card); border-radius: 10px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        
        /* Tablas */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        th { background: #f8fafc; font-weight: 700; color: #64748b; }
        tr:hover { background: #f8fafc; }
        .actions { display: flex; gap: 8px; }
        
        /* Botones */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.2s; }
        .btn-primary { background: var(--s); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-edit { background: #f59e0b; color: white; }
        
        /* Modal Form */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .hidden { display: none !important; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; width: 400px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.85rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 1.5rem; }

        /* Notification */
        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--p); color: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(100px); transition: 0.3s; }
        .toast.show { transform: translateY(0); }
    </style>
</head>
<body>

    <aside>
        <div class="brand">BUSES<span>CORDILLERA ADMINPANEL</span></div>
        <button class="nav-btn active" onclick="loadView('viajes')">üìÖ Programaci√≥n Viajes</button>
        <button class="nav-btn" onclick="loadView('buses')">üöå Gesti√≥n de Flota</button>
        <button class="nav-btn" onclick="loadView('pasajeros')">üë• Base Pasajeros</button>
        <button class="nav-btn" onclick="loadView('tramos')">üí∞ Precios y Tramos</button>
        <button class="nav-btn" onclick="loadView('tarifas')">üè∑Ô∏è Tipos de Tarifa</button>
        <div style="flex-grow:1"></div>
        <a href="index.html" class="nav-btn" style="text-align:center; background:#334155">‚¨Ö Volver a Venta</a>
    </aside>

    <main>
        <header>
            <h1 id="page-title">Programaci√≥n de Viajes</h1>
            <button class="btn btn-primary" onclick="openModal()">+ Nuevo Registro</button>
        </header>

        <div class="card">
            <div id="table-container">Cargando datos...</div>
        </div>
    </main>

    <!-- Modal Din√°mico -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-bottom:1.5rem">Nuevo Registro</h2>
            <form id="dynamic-form"></form>
            <div class="modal-footer">
                <button class="btn" style="background:#e2e8f0" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="saveData()">Guardar</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Operaci√≥n exitosa</div>

    <script>
        let currentView = 'viajes';
        let rawData = [];
        let metadata = {}; // Para guardar paradas, buses, rutas y llenar selects

        // CONFIGURACI√ìN DE VISTAS
        const schemas = {
            viajes: {
                title: "Programaci√≥n de Viajes",
                cols: ["ID", "Fecha/Hora", "Ruta", "Bus", "Chofer", "Estado"],
                fields: [
                    { name: "ruta_id", label: "Ruta", type: "select", source: "rutas" },
                    { name: "bus_id", label: "Bus", type: "select", source: "buses" },
                    { name: "chofer_nombre", label: "Nombre Chofer", type: "text" },
                    { name: "fecha_hora_salida", label: "Fecha y Hora Salida", type: "datetime-local" }
                ]
            },
            buses: {
                title: "Flota de Buses",
                cols: ["N¬∞ Interno", "Patente", "Modelo", "Asientos", "Estado"],
                fields: [
                    { name: "numero_bus", label: "N√∫mero Interno", type: "text" },
                    { name: "patente", label: "Patente", type: "text" },
                    { name: "modelo", label: "Modelo", type: "text" },
                    { name: "asientos", label: "Cantidad Asientos", type: "number" },
                    { name: "estado", label: "Estado", type: "select", options: [{id:'Activo', nombre:'Activo'}, {id:'En Panne', nombre:'En Panne'}] }
                ]
            },
            pasajeros: {
                title: "Base de Pasajeros",
                cols: ["RUT", "Nombre Completo", "Tel√©fono"],
                fields: [
                    { name: "rut", label: "RUT", type: "text", readonly: true }, // RUT es PK, mejor no editarlo directo o manejarlo con cuidado
                    { name: "nombre_completo", label: "Nombre Completo", type: "text" },
                    { name: "telefono", label: "Tel√©fono", type: "text" }
                ]
            },
            tramos: {
                title: "Precios por Tramo",
                cols: ["Origen", "Destino", "Precio"],
                fields: [
                    { name: "origen_id", label: "Origen", type: "select", source: "paradas" },
                    { name: "destino_id", label: "Destino", type: "select", source: "paradas" },
                    { name: "precio", label: "Precio ($)", type: "number" }
                ]
            },
            tarifas: {
                title: "Configuraci√≥n de Tarifas",
                cols: ["Nombre", "Descuento %"],
                fields: [
                    { name: "nombre", label: "Nombre Tarifa", type: "text" },
                    { name: "descuento", label: "Descuento (%)", type: "number" }
                ]
            }
        };

        // INICIO
        document.addEventListener('DOMContentLoaded', async () => {
            await loadMetadata();
            loadView('viajes');
        });

        async function loadMetadata() {
            const res = await fetch('api/app_init.php');
            const json = await res.json();
            if(json.success) {
                // Mapeamos para selects
                metadata.paradas = json.data.paradas;
                metadata.buses = json.data.buses.map(b => ({ id: b.id, nombre: `Bus ${b.numero_bus} (${b.patente})` }));
                metadata.rutas = json.data.rutas;
            }
        }

        async function loadView(view) {
            currentView = view;
            document.getElementById('page-title').innerText = schemas[view].title;
            
            // Actualizar Sidebar
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('button')?.classList.add('active');

            // Cargar Datos
            const fd = new FormData(); fd.append('table', view); fd.append('action', 'read');
            const res = await fetch('api/crud.php', { method: 'POST', body: fd });
            const json = await res.json();
            
            if(json.success) {
                rawData = json.data;
                renderTable();
            } else {
                document.getElementById('table-container').innerHTML = `<p style="color:red">Error: ${json.error}</p>`;
            }
        }

        function renderTable() {
            const config = schemas[currentView];
            let html = `<table><thead><tr>`;
            config.cols.forEach(c => html += `<th>${c}</th>`);
            html += `<th>Acciones</th></tr></thead><tbody>`;

            rawData.forEach(row => {
                html += `<tr>`;
                // Renderizado inteligente seg√∫n la vista
                if(currentView === 'viajes') {
                    const bus = metadata.buses.find(b => b.id == row.bus_id)?.nombre || 'N/A';
                    const ruta = metadata.rutas.find(r => r.id == row.ruta_id)?.nombre || 'N/A';
                    html += `<td>${row.id}</td><td>${row.fecha_hora_salida}</td><td>${ruta}</td><td>${bus}</td><td>${row.chofer_nombre}</td><td>${row.estado}</td>`;
                } else if(currentView === 'buses') {
                    html += `<td>${row.numero_bus}</td><td>${row.patente}</td><td>${row.modelo}</td><td>${row.asientos}</td><td>${row.estado}</td>`;
                } else if(currentView === 'pasajeros') {
                    html += `<td>${row.rut}</td><td>${row.nombre_completo}</td><td>${row.telefono || '-'}</td>`;
                } else if(currentView === 'tramos') {
                    const o = metadata.paradas.find(p => p.id == row.origen_id)?.nombre;
                    const d = metadata.paradas.find(p => p.id == row.destino_id)?.nombre;
                    html += `<td>${o}</td><td>${d}</td><td>$${parseInt(row.precio).toLocaleString()}</td>`;
                } else if(currentView === 'tarifas') {
                    html += `<td>${row.nombre}</td><td>${row.descuento}%</td>`;
                }

                // Botones
                const pk = currentView === 'pasajeros' ? row.rut : row.id;
                html += `<td>
                    <div class="actions">
                        <button class="btn btn-edit" onclick='editRow(${JSON.stringify(row)})'>Editar</button>
                        <button class="btn btn-danger" onclick="deleteRow('${pk}')">Borrar</button>
                    </div>
                </td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('table-container').innerHTML = html;
        }

        // --- MODAL & FORM ---
        let editId = null;

        function openModal(data = null) {
            editId = data ? (currentView === 'pasajeros' ? data.rut : data.id) : null;
            document.getElementById('modal-title').innerText = data ? "Editar Registro" : "Nuevo Registro";
            const form = document.getElementById('dynamic-form');
            form.innerHTML = '';

            schemas[currentView].fields.forEach(f => {
                let inputHtml = '';
                const val = data ? data[f.name] : '';
                
                if(f.type === 'select') {
                    let opts = metadata[f.source] || f.options || [];
                    let optHtml = opts.map(o => `<option value="${o.id}" ${o.id == val ? 'selected' : ''}>${o.nombre}</option>`).join('');
                    inputHtml = `<select name="${f.name}" ${f.readonly && data ? 'disabled' : ''}>${optHtml}</select>`;
                } else {
                    inputHtml = `<input type="${f.type}" name="${f.name}" value="${val}" ${f.readonly && data ? 'readonly' : ''}>`;
                }

                form.innerHTML += `
                    <div class="form-group">
                        <label>${f.label}</label>
                        ${inputHtml}
                    </div>`;
            });
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        window.editRow = (row) => openModal(row);

        async function saveData() {
            const form = document.getElementById('dynamic-form');
            const fd = new FormData(form);
            fd.append('action', editId ? 'update' : 'create');
            fd.append('table', currentView);
            if(editId) fd.append('id', editId); // Para Update

            const res = await fetch('api/crud.php', { method: 'POST', body: fd });
            const json = await res.json();
            
            if(json.success) {
                showToast("Guardado correctamente");
                closeModal();
                loadView(currentView);
            } else {
                alert("Error: " + json.error);
            }
        }

        async function deleteRow(id) {
            if(!confirm("¬øSeguro que deseas eliminar este registro?")) return;
            const fd = new FormData();
            fd.append('action', 'delete');
            fd.append('table', currentView);
            fd.append('id', id);

            const res = await fetch('api/crud.php', { method: 'POST', body: fd });
            const json = await res.json();
            if(json.success) {
                showToast("Eliminado correctamente");
                loadView(currentView);
            } else {
                alert("Error: " + json.error);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>